name: "Translation Checks"

on:
  pull_request:
    paths:
      - 'Jellyfin.Plugin.JellyfinEnhanced/js/locales/**.json'

jobs:
  validate-changed-translations:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get changed translation files
        id: changed_files
        run: |
          # Get all changed locale files in the PR
          changed_files=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...${{ github.sha }} -- 'Jellyfin.Plugin.JellyfinEnhanced/js/locales/*.json')
          new_files=$(git diff --name-only --diff-filter=A origin/${{ github.event.pull_request.base.ref }}...${{ github.sha }} -- 'Jellyfin.Plugin.JellyfinEnhanced/js/locales/*.json')

          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$changed_files" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "new_files<<EOF" >> $GITHUB_OUTPUT
          echo "$new_files" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Count number of changed files
          count=$(echo "$changed_files" | grep -c . || echo "0")
          echo "count=$count" >> $GITHUB_OUTPUT

          echo "Changed files:"
          echo "$changed_files"
          echo "New files:"
          echo "$new_files"

      - name: Validate new language file naming
        if: steps.changed_files.outputs.new_files != ''
        run: |
          echo "${{ steps.changed_files.outputs.new_files }}" | while IFS= read -r file; do
            if [ -z "$file" ]; then
              continue
            fi

            filename=$(basename "$file")
            echo "Checking filename: $filename"

            # Check if filename is a two-letter code followed by .json
            if ! [[ "$filename" =~ ^[a-z]{2}\.json$ ]]; then
              echo "::error file=$file::Invalid filename. Filename must be a two-letter ISO 639-1 language code (e.g., es.json, pl.json)."
              exit 1
            fi
          done

      - name: Validate changed translation files
        if: steps.changed_files.outputs.changed_files != ''
        run: |
          echo "${{ steps.changed_files.outputs.changed_files }}" | while IFS= read -r file; do
            if [ -z "$file" ] || [ ! -f "$file" ]; then
              continue
            fi

            lang=$(basename "$file" .json)
            if [ "$lang" = "en" ]; then
              echo "Skipping base language (en.json)"
              continue
            fi

            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "Validating: $lang"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            node scripts/validate-translations.js validate "$lang"
            if [ $? -ne 0 ]; then
              exit 1
            fi
          done

      - name: Show completion statistics (multiple files changed)
        if: steps.changed_files.outputs.count > 1
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Translation Completion Statistics"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          node scripts/validate-translations.js stats